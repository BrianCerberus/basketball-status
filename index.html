<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Basketball Status</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #ffffff;
      border-radius: 20px;
      padding: 32px 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 420px;
      width: 100%;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }
    .icon {
      font-size: 64px;
      margin-bottom: 16px;
      display: block;
    }
    .card h2 {
      margin: 0 0 20px 0;
      font-size: 26px;
      color: #1a1a2e;
      font-weight: 700;
    }
    .info-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 12px 16px;
      margin: 8px 0;
      background: #f8f9fa;
      border-radius: 12px;
      font-size: 16px;
      color: #333;
    }
    .info-row .emoji {
      font-size: 20px;
      margin-right: 12px;
      min-width: 24px;
    }
    .info-row .label {
      color: #666;
      margin-right: 8px;
    }
    .info-row .value {
      font-weight: 600;
      color: #1a1a2e;
    }
    .game-on .card::before {
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
    }
    .game-on .icon { animation: bounce 1s ease infinite; }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .no-game .card::before {
      background: linear-gradient(90deg, #ff9800, #ffc107);
    }
    .next-game {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 2px dashed #e0e0e0;
    }
    .next-game-label {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
      margin-bottom: 12px;
      font-weight: 600;
    }
    .next-game .info-row {
      background: #fff8e1;
    }
    .error .card::before {
      background: linear-gradient(90deg, #f44336, #e91e63);
    }
    .loading .card {
      color: #666;
    }
    .loading .icon {
      animation: spin 1.5s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .subtitle {
      color: #666;
      font-size: 15px;
      margin-top: 8px;
    }
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }
    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .action-btn.maps {
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
    }
    .action-btn.calendar {
      background: linear-gradient(135deg, #ea4335, #fbbc05);
      color: white;
    }
    .action-btn.subscribe {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    .subscribe-section {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 2px dashed #e0e0e0;
    }
    .subscribe-section .section-label {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
      margin-bottom: 12px;
      font-weight: 600;
    }
    .weather-row {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border: 1px solid #90caf9;
    }
    .weather-row .value {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .weather-icon {
      font-size: 24px;
    }
    .weather-details {
      font-size: 13px;
      color: #666;
      font-weight: normal;
    }
  </style>
</head>
<body>
  <div class="loading" id="wrapper">
    <div class="card" id="status">
      <span class="icon">&#x1F504;</span>
      <h2>Checking Schedule...</h2>
      <p class="subtitle">Loading basketball status</p>
    </div>
  </div>

  <script>
    const calendarId =
      "6b2ffcbd02ff052bd40ff5e2ed7c01082c2017740b3c044a55088cf02f3f4972@group.calendar.google.com";

    // Note: This API key is restricted to Calendar API and your GitHub Pages domain only
    const apiKey = "AIzaSyCOx2fmGOLBiVTCIpd06hTKb-Vx-bSi68g";

    const tz = "America/Toronto";

    // Detect iOS for Apple Maps vs Google Maps
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    // Helper: Generate maps URL (Apple Maps for iOS, Google Maps otherwise)
    function getMapsUrl(location) {
      if (!location) return null;
      const encoded = encodeURIComponent(location);
      if (isIOS) {
        return "maps://maps.apple.com/?q=" + encoded;
      }
      return "https://www.google.com/maps/search/?api=1&query=" + encoded;
    }

    // Helper: Generate ICS file content for calendar event
    function generateICS(event) {
      const title = event.summary || "Basketball Game";
      const location = event.location || "";
      const description = event.description || "";
      
      function formatICSDate(dateStr) {
        const d = new Date(dateStr);
        return d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      }
      
      let dtStart, dtEnd;
      if (event.start.dateTime) {
        dtStart = formatICSDate(event.start.dateTime);
        dtEnd = formatICSDate(event.end.dateTime);
      } else {
        dtStart = event.start.date.replace(/-/g, '');
        dtEnd = event.end.date.replace(/-/g, '');
      }
      
      const uid = dtStart + "-" + Math.random().toString(36).substr(2, 9) + "@basketball";
      
      const lines = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Basketball Status//EN',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH',
        'BEGIN:VEVENT',
        'UID:' + uid,
        'DTSTAMP:' + formatICSDate(new Date().toISOString()),
        event.start.dateTime ? 'DTSTART:' + dtStart : 'DTSTART;VALUE=DATE:' + dtStart,
        event.start.dateTime ? 'DTEND:' + dtEnd : 'DTEND;VALUE=DATE:' + dtEnd,
        'SUMMARY:' + title,
        location ? 'LOCATION:' + location : '',
        description ? 'DESCRIPTION:' + description.replace(/\n/g, '\\n') : '',
        'END:VEVENT',
        'END:VCALENDAR'
      ].filter(function(line) { return line; });
      
      return lines.join('\r\n');
    }

    // Helper: Download ICS file
    function downloadICS(event) {
      const ics = generateICS(event);
      const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'basketball-game.ics';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // Get subscribe URL for the calendar (webcal:// works on iOS, macOS, Outlook)
    function getSubscribeUrl() {
      return "webcal://calendar.google.com/calendar/ical/" + encodeURIComponent(calendarId) + "/public/basic.ics";
    }

    // Weather code to emoji and description mapping
    const weatherCodes = {
      0: { icon: 'â˜€ï¸', desc: 'Clear sky' },
      1: { icon: 'ðŸŒ¤ï¸', desc: 'Mainly clear' },
      2: { icon: 'â›…', desc: 'Partly cloudy' },
      3: { icon: 'â˜ï¸', desc: 'Overcast' },
      45: { icon: 'ðŸŒ«ï¸', desc: 'Foggy' },
      48: { icon: 'ðŸŒ«ï¸', desc: 'Icy fog' },
      51: { icon: 'ðŸŒ§ï¸', desc: 'Light drizzle' },
      53: { icon: 'ðŸŒ§ï¸', desc: 'Drizzle' },
      55: { icon: 'ðŸŒ§ï¸', desc: 'Heavy drizzle' },
      56: { icon: 'ðŸŒ¨ï¸', desc: 'Freezing drizzle' },
      57: { icon: 'ðŸŒ¨ï¸', desc: 'Heavy freezing drizzle' },
      61: { icon: 'ðŸŒ§ï¸', desc: 'Light rain' },
      63: { icon: 'ðŸŒ§ï¸', desc: 'Rain' },
      65: { icon: 'ðŸŒ§ï¸', desc: 'Heavy rain' },
      66: { icon: 'ðŸŒ¨ï¸', desc: 'Freezing rain' },
      67: { icon: 'ðŸŒ¨ï¸', desc: 'Heavy freezing rain' },
      71: { icon: 'ðŸŒ¨ï¸', desc: 'Light snow' },
      73: { icon: 'ðŸŒ¨ï¸', desc: 'Snow' },
      75: { icon: 'â„ï¸', desc: 'Heavy snow' },
      77: { icon: 'ðŸŒ¨ï¸', desc: 'Snow grains' },
      80: { icon: 'ðŸŒ§ï¸', desc: 'Light showers' },
      81: { icon: 'ðŸŒ§ï¸', desc: 'Showers' },
      82: { icon: 'â›ˆï¸', desc: 'Heavy showers' },
      85: { icon: 'ðŸŒ¨ï¸', desc: 'Light snow showers' },
      86: { icon: 'ðŸŒ¨ï¸', desc: 'Snow showers' },
      95: { icon: 'â›ˆï¸', desc: 'Thunderstorm' },
      96: { icon: 'â›ˆï¸', desc: 'Thunderstorm with hail' },
      99: { icon: 'â›ˆï¸', desc: 'Severe thunderstorm' }
    };

    // Fetch weather for game time (using Open-Meteo API - free, no key required)
    async function getWeatherForGame(event) {
      try {
        // Get location from event
        const locationStr = event.location;
        if (!locationStr) return null;
        
        // Geocode the location using Nominatim (OpenStreetMap) - free, no key required
        const geocodeUrl = "https://nominatim.openstreetmap.org/search" +
          "?q=" + encodeURIComponent(locationStr) +
          "&format=json" +
          "&limit=1";
        
        const geocodeResponse = await fetch(geocodeUrl, {
          headers: {
            'User-Agent': 'BasketballStatus/1.0'
          }
        });
        
        if (!geocodeResponse.ok) return null;
        const geocodeData = await geocodeResponse.json();
        
        if (!geocodeData || geocodeData.length === 0) return null;
        
        const lat = parseFloat(geocodeData[0].lat);
        const lon = parseFloat(geocodeData[0].lon);
        
        // Get the game start time
        const gameTime = event.start.dateTime ? new Date(event.start.dateTime) : new Date(event.start.date);
        const today = new Date();
        
        // Only fetch weather if game is within 7 days (forecast limit)
        const daysUntil = Math.ceil((gameTime - today) / (1000 * 60 * 60 * 24));
        if (daysUntil > 7 || daysUntil < 0) {
          return null;
        }
        
        const dateStr = gameTime.toISOString().split('T')[0];
        const hour = gameTime.getHours();
        
        const weatherUrl = "https://api.open-meteo.com/v1/forecast" +
          "?latitude=" + lat +
          "&longitude=" + lon +
          "&hourly=temperature_2m,weather_code,precipitation_probability" +
          "&timezone=America/Toronto" +
          "&start_date=" + dateStr +
          "&end_date=" + dateStr;
        
        const response = await fetch(weatherUrl);
        if (!response.ok) return null;
        
        const data = await response.json();
        
        // Find the hour closest to game time
        const hourIndex = Math.min(hour, 23);
        const temp = Math.round(data.hourly.temperature_2m[hourIndex]);
        const code = data.hourly.weather_code[hourIndex];
        const precipProb = data.hourly.precipitation_probability[hourIndex];
        
        const weather = weatherCodes[code] || { icon: 'ðŸŒ¡ï¸', desc: 'Unknown' };
        
        return {
          temp: temp,
          icon: weather.icon,
          desc: weather.desc,
          precipProb: precipProb
        };
      } catch (err) {
        console.error("Weather fetch error:", err);
        return null;
      }
    }

    // Helper: Check if event is basketball-related
    function isBasketballEvent(event) {
      const title = (event.summary || "").toLowerCase();
      return title.includes("basketball") || 
             title.includes("game") || 
             title.includes("tuesday game");
    }

    // Helper: Format time from event
    function formatTime(event) {
      if (event.start.dateTime) {
        return new Date(event.start.dateTime).toLocaleTimeString("en-CA", {
          hour: "numeric",
          minute: "2-digit",
          hour12: true
        });
      }
      return "All day";
    }

    // Helper: Format date for display
    function formatDate(event) {
      const dateStr = event.start.dateTime || event.start.date;
      const date = new Date(dateStr);
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      if (date.toDateString() === today.toDateString()) {
        return "Today";
      } else if (date.toDateString() === tomorrow.toDateString()) {
        return "Tomorrow";
      }
      
      return date.toLocaleDateString("en-CA", {
        weekday: "long",
        month: "short",
        day: "numeric"
      });
    }

    // Helper: Get days until event
    function getDaysUntil(event) {
      const dateStr = event.start.dateTime || event.start.date;
      const eventDate = new Date(dateStr);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      eventDate.setHours(0, 0, 0, 0);
      const diffTime = eventDate - today;
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    // Build API URL
    function buildUrl(startDate, endDate) {
      return "https://www.googleapis.com/calendar/v3/calendars/" + encodeURIComponent(calendarId) + "/events" +
        "?key=" + apiKey +
        "&timeMin=" + startDate.toISOString() +
        "&timeMax=" + endDate.toISOString() +
        "&singleEvents=true" +
        "&orderBy=startTime" +
        "&timeZone=" + encodeURIComponent(tz);
    }

    // Store current game for ICS download
    let currentGame = null;

    function downloadCurrentGameICS() {
      if (currentGame) {
        downloadICS(currentGame);
      }
    }

    // Render game info rows with action buttons
    function renderGameInfo(game, showDate, weather) {
      const time = formatTime(game);
      const location = game.location || "Location TBD";
      const title = game.summary || "Basketball Game";
      const mapsUrl = getMapsUrl(game.location);
      const mapsLabel = isIOS ? "Apple Maps" : "Google Maps";
      
      let html = '';
      
      if (showDate) {
        const dateDisplay = formatDate(game);
        html += '<div class="info-row">' +
          '<span class="emoji">&#x1F4C5;</span>' +
          '<span class="label">Date:</span>' +
          '<span class="value">' + dateDisplay + '</span>' +
          '</div>';
      }
      
      html += '<div class="info-row">' +
        '<span class="emoji">&#x1F4CB;</span>' +
        '<span class="label">Event:</span>' +
        '<span class="value">' + title + '</span>' +
        '</div>' +
        '<div class="info-row">' +
        '<span class="emoji">&#x23F0;</span>' +
        '<span class="label">Time:</span>' +
        '<span class="value">' + time + '</span>' +
        '</div>' +
        '<div class="info-row">' +
        '<span class="emoji">&#x1F4CD;</span>' +
        '<span class="label">Location:</span>' +
        '<span class="value">' + location + '</span>' +
        '</div>';
      
      // Add weather row if available
      if (weather) {
        html += '<div class="info-row weather-row">' +
          '<span class="emoji">&#x1F321;&#xFE0F;</span>' +
          '<span class="label">Weather:</span>' +
          '<span class="value">' +
          '<span class="weather-icon">' + weather.icon + '</span>' +
          '<span>' + weather.temp + 'Â°C ' + weather.desc + '</span>' +
          '<span class="weather-details">(' + weather.precipProb + '% precip)</span>' +
          '</span>' +
          '</div>';
      }
      
      html += '<div class="action-buttons">';
      
      if (mapsUrl) {
        html += '<a href="' + mapsUrl + '" target="_blank" class="action-btn maps">&#x1F5FA;&#xFE0F; ' + mapsLabel + '</a>';
      }
      html += '<button onclick="downloadCurrentGameICS()" class="action-btn calendar">&#x1F4C5; Add to Calendar</button>' +
        '</div>';
      
      return html;
    }

    // Render subscribe section
    function renderSubscribeSection() {
      const hint = isIOS ? "Opens in iPhone Calendar" : "Works with most calendar apps";
      return '<div class="subscribe-section">' +
        '<div class="section-label">Stay Updated</div>' +
        '<div class="action-buttons">' +
        '<a href="' + getSubscribeUrl() + '" class="action-btn subscribe">&#x1F4F2; Subscribe to Calendar</a>' +
        '</div>' +
        '<p class="subtitle" style="margin-top: 12px; font-size: 12px;">' + hint + '</p>' +
        '</div>';
    }

    async function checkBasketballStatus() {
      const wrapper = document.getElementById("wrapper");
      const el = document.getElementById("status");

      try {
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        const todayEnd = new Date();
        todayEnd.setHours(23, 59, 59, 999);

        const todayResponse = await fetch(buildUrl(todayStart, todayEnd));
        if (!todayResponse.ok) throw new Error("HTTP " + todayResponse.status);
        const todayData = await todayResponse.json();
        
        if (todayData.error) {
          throw new Error(todayData.error.message || "Calendar API error");
        }

        const todayGames = (todayData.items || []).filter(isBasketballEvent);

        wrapper.classList.remove("loading");

        if (todayGames.length > 0) {
          const game = todayGames[0];
          currentGame = game;
          
          // Fetch weather for game time
          const weather = await getWeatherForGame(game);
          
          wrapper.classList.add("game-on");
          el.innerHTML = '<span class="icon">&#x1F3C0;</span>' +
            '<h2>Game Tonight!</h2>' +
            renderGameInfo(game, false, weather) +
            renderSubscribeSection();
        } else {
          const futureStart = new Date();
          futureStart.setDate(futureStart.getDate() + 1);
          futureStart.setHours(0, 0, 0, 0);
          
          const futureEnd = new Date();
          futureEnd.setDate(futureEnd.getDate() + 60);

          const futureResponse = await fetch(buildUrl(futureStart, futureEnd));
          if (!futureResponse.ok) throw new Error("HTTP " + futureResponse.status);
          const futureData = await futureResponse.json();

          const upcomingGames = (futureData.items || []).filter(isBasketballEvent);

          wrapper.classList.add("no-game");

          if (upcomingGames.length > 0) {
            const nextGame = upcomingGames[0];
            currentGame = nextGame;
            const daysUntil = getDaysUntil(nextGame);
            const daysText = daysUntil === 1 ? "1 day" : daysUntil + " days";
            
            // Fetch weather for upcoming game (if within 7 days)
            const weather = await getWeatherForGame(nextGame);

            el.innerHTML = '<span class="icon">&#x1F634;</span>' +
              '<h2>No Game Today</h2>' +
              '<p class="subtitle">Next game in ' + daysText + '</p>' +
              '<div class="next-game">' +
              '<div class="next-game-label">Upcoming Game</div>' +
              renderGameInfo(nextGame, true, weather) +
              '</div>' +
              renderSubscribeSection();
          } else {
            el.innerHTML = '<span class="icon">&#x1F4ED;</span>' +
              '<h2>No Games Scheduled</h2>' +
              '<p class="subtitle">No upcoming games found in the next 60 days</p>' +
              renderSubscribeSection();
          }
        }
      } catch (err) {
        wrapper.classList.remove("loading");
        wrapper.classList.add("error");
        el.innerHTML = '<span class="icon">&#x26A0;&#xFE0F;</span>' +
          '<h2>Unable to Load</h2>' +
          '<p class="subtitle">Could not fetch calendar data.<br>Please try again later.</p>';
        console.error("Calendar fetch error:", err);
      }
    }

    checkBasketballStatus();
  </script>
</body>
</html>
